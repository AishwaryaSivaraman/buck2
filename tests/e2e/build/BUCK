load("@fbcode//buck2/tests:buck_e2e.bzl", "buck2_e2e_test")

oncall("build_infra")

buck2_e2e_test(
    name = "test_build_isolated",
    srcs = ["test_build_isolated.py"],
    data = "//buck2/tests/targets:isolated_targets",
    env = {
        "OVR_CONFIG": "1",
        "PRELUDE": "$(location prelude//:prelude)",
    },
    serialize_test_cases = False,
    deps = [
        "fbcode//buck2/tests/e2e_util:assert_occurrences",
        "fbcode//buck2/tests/e2e_util:utils",
        "fbsource//third-party/pypi/aiohttp:aiohttp",
    ],
)

buck2_e2e_test(
    name = "test_output_cleanup",
    srcs = ["test_output_cleanup.py"],
    data_dir = "test_output_cleanup_data",
    serialize_test_cases = False,
)

buck2_e2e_test(
    name = "test_build_configured",
    srcs = ["test_build_configured.py"],
)

buck2_e2e_test(
    name = "test_build_inplace",
    srcs = ["test_build_inplace.py"],
    require_nano_prelude = True,
    deps = [
        "//buck2/tests/e2e_util:utils",
    ],
)

buck2_e2e_test(
    name = "test_build_serial",
    srcs = ["test_build_serial.py"],
    tags = ["serialize_test_cases"],
)

buck2_e2e_test(
    name = "test_build_universe",
    srcs = ["test_build_universe.py"],
)

buck2_e2e_test(
    name = "test_build_skip_missing",
    srcs = ["test_build_skip_missing.py"],
)

buck2_e2e_test(
    name = "test_paranoid",
    srcs = ["test_paranoid.py"],
    data = "//buck2/tests/targets:isolated_targets",
    serialize_test_cases = False,
)

buck2_e2e_test(
    name = "test_error_categorization",
    srcs = ["test_error_categorization.py"],
    data_dir = "test_error_categorization_data",
    deps = [
        "//buck2/tests/e2e_util:utils",
    ],
)

buck2_e2e_test(
    name = "test_worker",
    srcs = ["test_worker.py"],
    tags = ["long_running"],
    deps = [
        "//buck2/tests/e2e_util:utils",
    ],
)

buck2_e2e_test(
    name = "test_action_digest",
    srcs = ["test_action_digest.py"],
    # This test is currently broken on Windows due to rustc_link non-determinism
    # https://fb.workplace.com/groups/346627374465346/permalink/511477684646980/
    skip_for_os = [
        "windows",
    ],
    # DO NOT Modify or add more test flags,
    # this is used to gate changes that modify action_digest.
    # Changing it will prevent the test from working properly
    test_with_compiled_buck2 = True,
    deps = [
        "//buck2/tests/e2e_util:utils",
    ],
)
